syntax = "proto3";

package network_tonic;

import "datafusion_common.proto";
import "datafusion.proto";
import "arrow_flight.proto";

service DistTonicService {
   rpc SendTasks (SendTasksReq) returns (SendTasksResp) {}
   rpc ExecuteTask (TaskId) returns (stream arrow_flight.FlightData) {}
   rpc GetJobStatus (GetJobStatusReq) returns (GetJobStatusResp) {}
   rpc CleanupJob (CleanupJobReq) returns (CleanupJobResp) {}
}

message SendTasksReq {
  repeated StagePlan stage_plans = 1;
  repeated TaskId tasks = 2;
  TaskDistribution job_task_distribution = 3;
  map<string, string> meta = 4;
}

message SendTasksResp {}

message StageId {
  string job_id = 1;
  uint32 stage = 2;
}

message TaskId {
  string job_id = 1;
  uint32 stage = 2;
  uint32 partition = 3;
}

message StagePlan {
  StageId stage_id = 1;
  bytes plan = 2;
}

message GetJobStatusReq {
  optional string job_id = 1;
}

message GetJobStatusResp {
  repeated StageInfo stage_infos = 1;
}

message StageInfo {
  StageId stage_id = 1;
  int64 created_at_ms = 2;
  repeated uint32 assigned_partitions = 3;
  repeated TaskSetInfo task_set_infos = 4;
}

message TaskSetInfo {
  repeated uint32 running_partitions = 1;
  repeated DroppedPartition dropped_partitions = 2;
}

message DroppedPartition {
  uint32 partition = 1;
  TaskMetrics metrics = 2;
}

message TaskMetrics {
  uint64 output_bytes = 1;
  uint64 output_rows = 2;
  bool completed = 3;
}

message CleanupJobReq {
  string job_id = 1;
}

message CleanupJobResp {}

message DistPhysicalPlanNode {
  oneof DistPhysicalPlanType {
    ProxyExecNode proxy = 1;
  }
}

message ProxyExecNode {
  StageId delegated_stage_id = 1;
  string delegated_plan_name = 2;
  TaskDistribution delegated_task_distribution = 3;
  datafusion_common.Schema schema = 4;
  datafusion.Partitioning partitioning = 5;
}

message TaskDistribution {
  repeated TaskNode distribution = 1;
}

message TaskNode {
  TaskId task_id = 1;
  NodeId node_id = 2;
}

message NodeId {
  string host = 1;
  uint32 port = 2;
}
