syntax = "proto3";

package network_tonic;

import "datafusion_common.proto";
import "datafusion.proto";

service DistTonicService {
   rpc SendTasks (SendTasksReq) returns (SendTasksResp) {}
   rpc ExecuteTask (TaskId) returns (stream RecordBatch) {}
   rpc GetJobStatus (GetJobStatusReq) returns (GetJobStatusResp) {}
}

message SendTasksReq {
  repeated StagePlan stage_plans = 1;
  repeated TaskId tasks = 2;
}

message SendTasksResp {}

message StageId {
  string job_id = 1;
  uint32 stage = 2;
}

message TaskId {
  string job_id = 1;
  uint32 stage = 2;
  uint32 partition = 3;
}

message StagePlan {
  StageId stage_id = 1;
  bytes plan = 2;
}

message RecordBatch {
  bytes data = 1;
}

message GetJobStatusReq {
  string job_id = 1;
}

message GetJobStatusResp {
  repeated StageInfo stage_infos = 1;
}

message StageInfo {
  StageId stage_id = 1;
  repeated uint32 assigned_partitions = 2;
  repeated TaskSetInfo task_set_infos = 3;
}

message TaskSetInfo {
  repeated uint32 running_partitions = 1;
  repeated uint32 completed_partitions = 2;
}

message DistPhysicalPlanNode {
  oneof DistPhysicalPlanType {
    ProxyExecNode proxy = 1;
  }
}

message ProxyExecNode {
  StageId delegated_stage_id = 1;
  string delegated_plan_name = 2;
  TaskDistribution delegated_task_distribution = 3;
  datafusion_common.Schema schema = 4;
  datafusion.Partitioning partitioning = 5;
}

message TaskDistribution {
  repeated TaskNode distribution = 1;
}

message TaskNode {
  TaskId task_id = 1;
  NodeId node_id = 2;
}

message NodeId {
  string host = 1;
  uint32 port = 2;
}
